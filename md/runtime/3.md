##Runtime

##### ä¸€.runtimeç®€ä»‹

- runtimeç®€ç§°è¿è¡Œæ—¶ï¼ŒOCå°±æ˜¯`è¿è¡Œæ—¶æœºåˆ¶`ï¼Œä¹Ÿå°±æ˜¯åœ¨è¿è¡Œæ—¶å€™çš„ä¸€äº›æœºåˆ¶ï¼Œå…¶ä¸­æœ€ä¸»è¦çš„æ˜¯æ¶ˆæ¯æœºåˆ¶ã€‚
- å¯¹äºCè¯­è¨€ï¼Œ`å‡½æ•°çš„è°ƒç”¨åœ¨ç¼–è¯‘æ—¶ä¼šå†³å®šè°ƒç”¨å“ªä¸ªå‡½æ•°`ã€‚
- å¯¹äºOCçš„å‡½æ•°ï¼Œå±äº`åŠ¨æ€è°ƒç”¨è¿‡ç¨‹`ï¼Œåœ¨ç¼–è¯‘çš„æ—¶å€™ä¸èƒ½å†³å®šçœŸæ­£è°ƒç”¨å“ªä¸ªå‡½æ•°ï¼Œåªæœ‰åœ¨çœŸæ­£è¿è¡Œçš„æ—¶å€™æ‰ä¼šæ ¹æ®å‡½æ•°çš„åç§°æ‰¾åˆ°å¯¹åº”çš„å‡½æ•°æ¥è°ƒç”¨ã€‚
- äº‹å®è¯æ˜ï¼š
   â‘  åœ¨ç¼–è¯‘é˜¶æ®µï¼šOCå¯ä»¥è°ƒç”¨ä»»ä½•å‡½æ•°ï¼Œå³ä½¿è¿™ä¸ªå‡½æ•°å¹¶æœªå®ç°ï¼Œåªè¦å£°æ˜è¿‡å°±ä¸ä¼šæŠ¥é”™ã€‚
   â‘¡ åœ¨ç¼–è¯‘é˜¶æ®µï¼šCè¯­è¨€è°ƒç”¨`æœªå®ç°çš„å‡½æ•°`å°±ä¼šæŠ¥é”™ã€‚

**runtimeçš„äº”ä¸ªåŠŸèƒ½**

> 1.å‘é€æ¶ˆæ¯
>  2.äº¤æ¢æ–¹æ³•
>  3.åŠ¨æ€æ·»åŠ æ–¹æ³•
>  4.ç»™åˆ†ç±»æ·»åŠ å±æ€§
>  5.å­—å…¸è½¬æ¨¡å‹

- æ–¹æ³•è°ƒç”¨çš„æœ¬è´¨ï¼Œå°±æ˜¯è®©å¯¹è±¡å‘é€æ¶ˆæ¯ã€‚
- objc_msgSend,åªæœ‰å¯¹è±¡æ‰èƒ½å‘é€æ¶ˆæ¯ï¼Œå› æ­¤ä»¥objcå¼€å¤´ã€‚
- ä½¿ç”¨`æ¶ˆæ¯æœºåˆ¶`å‰æï¼Œå¿…é¡»å¯¼å…¥**#import <objc/runtime.h>** 
- æ¶ˆæ¯æœºåˆ¶ç®€å•ä½¿ç”¨ã€‚
- clang-rewrite-objc main.mæŸ¥çœ‹æœ€ç»ˆç”Ÿæˆä»£ç ã€‚

##### äºŒ.Runtime(æ¶ˆæ¯æœºåˆ¶)

æ¶ˆæ¯æœºåˆ¶æ˜¯OCä¸­æ˜¯æœ€ä¸»è¦çš„æœºåˆ¶ï¼Œä»»ä½•æ–¹æ³•çš„è°ƒç”¨æœ¬è´¨éƒ½æ˜¯**å‘é€æ¶ˆæ¯**ï¼Œç”¨runtimeå‘é€æ¶ˆæ¯ï¼ŒOCåº•å±‚é€šè¿‡runtimeæ¥å®ç°ã€‚
 **éªŒè¯:**
 `æ˜¯å¦çœŸçš„æ˜¯è½¬æ¢ä¸ºæ¶ˆæ¯æœºåˆ¶`
 ç¬¬ä¸€æ­¥ï¼šcdè¿›å…¥åˆ°è¯¥æ–‡ä»¶å¤¹
 ç¬¬äºŒæ­¥ï¼šåœ¨ç»ˆç«¯æ‰§è¡Œ**clang -rewrite-objc æ–‡ä»¶å** å‘½ä»¤
 ç¬¬ä¸‰æ­¥ï¼šè¯¥å‘½ä»¤æˆåŠŸåå°±ä¼šç”Ÿæˆä¸€ä¸ª.cppçš„æ–‡ä»¶ã€‚

```
allisondeMacBook-Pro:123 allison$ clang -x objective-c -rewrite-objc -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator.sdk ViewController.m
clang: warning: using sysroot for 'iPhoneSimulator' but targeting 'MacOSX' [-Wincompatible-sysroot]
/var/folders/nm/4974_cj15s5gyjfg8wj077qm0000gn/T/ViewController-78b550.mi:12798:188: warning: 
      'kCFCalendarUnitWeek' is deprecated: first deprecated in macOS 10.10 - Use
      kCFCalendarUnitWeekOfYear or kCFCalendarUnitWeekOfMonth instead
      [-Wdeprecated-declarations]
  ...or NSCalendarUnitWeekOfYear, depending on which you mean"))) = kCFCalend...
                                                                    ^
/var/folders/nm/4974_cj15s5gyjfg8wj077qm0000gn/T/ViewController-78b550.mi:5147:2: note: 
      'kCFCalendarUnitWeek' has been explicitly marked deprecated here
 kCFCalendarUnitWeek __attribute__((availability(macos,introduced=10.4,d...
 ^
1 warning generated.
```

æŸ¥çœ‹ViewController.cppæ–‡ä»¶ï¼Œæˆ‘ä»¬å‘ç°æœ‰**64871**è¡Œä»£ç ï¼ŒæŸ¥æ‰¾**viewDidLoad**æ–¹æ³•ï¼Œæˆ‘ä»¬çœ‹.cppæ–‡ä»¶ä¸­viewDdiloadæ–¹æ³•ä¸­ç”Ÿæˆçš„ä»£ç ï¼š

```
// @implementation ViewController

static void _I_ViewController_viewDidLoad(ViewController * self, SEL _cmd) {
    ((void (*)(__rw_objc_super *, SEL))(void *)objc_msgSendSuper)((__rw_objc_super){(id)self, (id)class_getSuperclass(objc_getClass("ViewController"))}, sel_registerName("viewDidLoad"));


    id objc = ((NSObject *(*)(id, SEL))(void *)objc_msgSend)((id)objc_getClass("NSObject"), sel_registerName("alloc"));
    objc = ((id (*)(id, SEL))(void *)objc_msgSend)((id)objc, sel_registerName("init"));

}
```

æˆ‘ä»¬**ViewController.m**å†™çš„ä»£ç 

```
- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view, typically from a nib.
    
    id objc = [NSObject alloc];
    objc = [objc init];
}
```

ä¾‹å­ï¼šè¿ç”¨è¿è¡Œæ—¶å»åˆ›å»ºä¸€ä¸ªNSObjectå¯¹è±¡ã€‚(æˆ‘ä»¬å¯ä»¥å‚è€ƒViewController.cppç±»é‡Œé¢çš„viewDidLoadæ–¹æ³•)

```
    id objc = ((NSObject *(*)(id, SEL))(void *)objc_msgSend)((id)objc_getClass("NSObject"), sel_registerName("alloc"));
    objc = ((id (*)(id, SEL))(void *)objc_msgSend)((id)objc, sel_registerName("init"));
```

ä¸Šé¢è¿™ä¸ªæ˜¯æœ€åº•å±‚çš„ï¼Œä¸‹é¢æˆ‘ä»¬å¯ä»¥ç”¨è‹¹æœå°è£…å¥½çš„æ–¹æ³•ï¼Œæ•ˆæœæ˜¯ä¸€æ ·çš„ï¼š

```
    id objc = objc_msgSend([NSObject class], @selector(alloc));
    objc = objc_msgSend(objc, @selector(init));
```

è¿™é‡Œï¼Œä»æ§åˆ¶å°æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œæˆ‘ä»¬å·²ç»åˆ†é…å†…å­˜ï¼Œå¹¶ä¸”æ²¡æœ‰é”™è¯¯ã€‚



![img](../../img/ui-3-0-1.png)

**Tips1**

æœ¬æ¥æƒ³åœ¨mainå‡½æ•°ä¸­è¯•éªŒï¼Œä½†æ˜¯åœ¨mainå‡½æ•°ä¸­çš„æ—¶å€™ï¼Œä½¿ç”¨ `allison$ clang -rewrite-objc main.m`å‘½ä»¤çš„æ—¶å€™æ€»æ˜¯æŠ¥å¦‚ä¸‹é”™è¯¯ï¼Œæ‰€ä»¥æœ€ååœ¨ViewControllerä¸­ç”Ÿæˆcppæ–‡ä»¶æˆåŠŸã€‚ï¼ˆæš‚ä¸æ¸…æ¥šåŸå› ï¼Œè¿˜è¯·å„ä½çŸ¥é“çš„ç•™è¨€æŒ‡æ­£ï¼‰

```
allisondeMacBook-Pro:Clang allison$ clang -rewrite-objc main.m
main.m:9:9: fatal error: 'UIKit/UIKit.h' file not found
#import <UIKit/UIKit.h>
        ^~~~~~~~~~~~~~~
1 error generated.
allisondeMacBook-Pro:
```

**Tips2**

æˆ‘ä»¬ç”¨**objc_msgSend**å‡½æ•°çš„æ—¶å€™ï¼Œå¯èƒ½æ²¡æœ‰æç¤ºï¼Œè¿™æ˜¯å› ä¸ºåœ¨xcode6ä¹‹åï¼Œè‹¹æœä¸æ¨èä½¿ç”¨runtimeï¼Œå› ä¸ºè‹¹æœä¸æƒ³è®©å¼€å‘è€…äº†è§£åº•å±‚çš„å®ç°ï¼Œåªæƒ³è®©å¼€å‘è€…ç›´æ¥ä½¿ç”¨APIå³å¯ã€‚ä½†æ˜¯è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥å°†ä¸¥æ ¼æ£€æµ‹æ¶ˆæ¯æœºåˆ¶è¿™ä¸ªé€‰é¡¹å…³é—­ï¼Œä½¿ç”¨**objc_msgSend**å‡½æ•°çš„æ—¶å€™ä¾¿ä¼šæç¤ºäº†ï¼Œè®¾ç½®å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](../../img/ui-3-0-2.png)



![img](../../img/ui-3-0-3.png)

##### ä¸‰. Runtime(æ¶ˆæ¯æœºåˆ¶è°ƒç”¨å¤šä¸ªå‚æ•°)

**å¼€å‘ä¸­ä»€ä¹ˆæ—¶å€™ç”¨runtimeï¼Ÿ**

> 1.å¯ä»¥å¸®æˆ‘ä»¬è°ƒç”¨ç§æœ‰çš„æ–¹æ³•ã€‚ï¼ˆä¾‹å­ï¼šåŒäº‹å°è£…çš„ä¸€ä¸ªæ¯”è¾ƒå¥½çš„ç±»ï¼Œè¯¥ç±»ä¸­éƒ½æ˜¯ç§æœ‰æ–¹æ³•ï¼Œæˆ‘ä»¬æƒ³ä½¿ç”¨è¯¥æ–¹æ³•ï¼Œä¸€èˆ¬æ˜¯ä¸ä¼šç›´æ¥ä¿®æ”¹.hæ–‡ä»¶ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥ä½¿ç”¨runtimeæ¥å®ç°ï¼‰ã€‚
>
> 2.è‹¹æœç³»ç»ŸAPIä¸­ï¼Œå¦‚æœå‘ç°æŸä¸ªç§æœ‰çš„APIæ¯”è¾ƒå¥½ç”¨ï¼Œå¦‚æœæˆ‘ä»¬æƒ³ä½¿ç”¨ï¼Œå¯ä»¥é€šè¿‡objc_msgSendæ¥è°ƒç”¨ç§æœ‰çš„apiã€‚

##### å››.æ–¹æ³•è°ƒç”¨æµç¨‹

```
è°ƒç”¨setæ–¹æ³•å¯¹è±¡æ–¹æ³•ï¼šç±»å¯¹è±¡çš„æ–¹æ³•åˆ—è¡¨ï¼›ç±»æ–¹æ³•ï¼šå…ƒç±»ä¸­æ–¹æ³•åˆ—è¡¨ã€‚
```

- å†…å­˜äº”å¤§åŒºï¼š
- 1.æ ˆï¼šä¸éœ€è¦æ‰‹åŠ¨ç®¡ç†å†…å­˜ï¼Œè‡ªåŠ¨ç®¡ç†
- 2.å †ï¼šéœ€è¦æ‰‹åŠ¨ç®¡ç†å†…å­˜ï¼Œæ‰‹åŠ¨é‡Šæ”¾
- 3.é™æ€åŒº
- 4.å¸¸é‡åŒº
- 5.æ–¹æ³•åŒº

**æ–¹æ³•è°ƒç”¨æµç¨‹ï¼š**

![img](../../img/ui-3-0-4.png)



> 1.é€šè¿‡isaæŒ‡é’ˆå»å¯¹åº”çš„ç±»ä¸­æŸ¥æ‰¾ã€‚
>  2.æ³¨å†Œæ–¹æ³•ç¼–å·
>  3.æ ¹æ®æ–¹æ³•ç¼–å·å»æŸ¥æ‰¾å¯¹åº”çš„æ–¹æ³•ã€‚
>  4.æ‰¾åˆ°åªæ˜¯æœ€ç»ˆå‡½æ•°å®ç°åœ°å€ï¼Œæ ¹æ®åœ°å€å»æ–¹æ³•åŒºè°ƒç”¨å¯¹åº”å‡½æ•°ã€‚

##### äº”.Runtime(äº¤æ¢æ–¹æ³•&è‡ªå®šä¹‰UIImage)

**å¼€å‘ä¸­ä»€ä¹ˆæ—¶å€™ä½¿ç”¨runtime(äº¤æ¢æ–¹æ³•)ï¼Ÿ**
 éœ€æ±‚1ï¼šæ¯æ¬¡UIImageåŠ è½½å›¾ç‰‡ï¼Œè¿”å›æ˜¯å¦åŠ è½½æˆåŠŸï¼

**æ–¹æ³•1.ï¼š**è‡ªå®šä¹‰UIImageç±»ã€‚
 `å¼Šç«¯ï¼šâ‘ .æ¯æ¬¡ä½¿ç”¨éƒ½éœ€è¦å¯¼å…¥ â‘¡.è€é¡¹ç›®/å¤§é¡¹ç›®å¤§é‡ä½¿ç”¨UIImageï¼Œæ›¿æ¢ä¸æ˜“ã€‚`
 **æ–¹æ³•2ï¼š** ç»™UIImageæ·»åŠ åˆ†ç±»ã€‚
 `å¼Šç«¯ï¼šâ‘ .åœ¨åˆ†ç±»ä¸­æ–¹æœ€å¥½ä¸è¦é‡å†™ç³»ç»Ÿæ–¹æ³•ï¼Œä¸€æ—¦é‡å†™ï¼ŒæŠŠç³»ç»Ÿæ–¹æ³•å®ç°å°±ç»™è¦†ç›–äº†ã€‚â‘¡åˆ†ç±»ä¸­ä¸èƒ½è°ƒç”¨superæ–¹æ³•ã€‚`
 **æ–¹æ³•3ï¼š**ä½¿ç”¨runtime(äº¤æ¢æ–¹æ³•)æ¥å®ç°ã€‚

![img](../../img/ui-3-0-5.png)



(1)ç»™ç³»ç»Ÿçš„æ–¹æ³•æ·»åŠ åˆ†ç±»ã€‚
 (2)è‡ªå·±å®ç°ä¸€ä¸ªå¸¦æœ‰æ‰©å±•åŠŸèƒ½çš„æ–¹æ³•,å¦‚ï¼š`bdf_imageNamed`ã€‚
 (3)äº¤æ¢`imageNamed`å’Œ`bdf_imageNamed`æ–¹æ³•ã€‚

ä¸»è¦ä»£ç ï¼š

```
    // è·å–ç³»ç»Ÿæ–¹æ³•
    // Class  _Nullable __unsafe_unretained cls è·å–é‚£ä¸ªç±»çš„æ–¹æ³•
    // SEL  _Nonnull nameï¼šè·å–é‚£ä¸ªæ–¹æ³•
    Method imageNameMethod = class_getClassMethod(self, @selector(selectedImage:));
    // è·å–è‡ªå®šä¹‰æ–¹æ³•
    Method bdf_imageNameMethod = class_getClassMethod(self, @selector(bdf_selectedImage:));
    // äº¤æ¢æ–¹æ³•
    method_exchangeImplementations(imageNameMethod, bdf_imageNameMethod);
```

##### å…­.Runtime(åŠ¨æ€æ·»åŠ æ–¹æ³•)

èµ·æºï¼šé¢è¯•é¢˜ä¸­ï¼Œé—®æœ‰æ²¡æœ‰ä½¿ç”¨è¿‡**performSelector**?
 `self performSelector:<#(SEL)#>`
 ç­”ï¼šåŠ¨æ€æ·»åŠ æ–¹æ³•çš„æ—¶å€™ä½¿ç”¨è¿‡ï¼
 è¿™é‡Œè¯·è‡ªè¡ŒæŸ¥é˜…[runtimeå®˜æ–¹æ–‡æ¡£](https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtDynamicResolution.html#//apple_ref/doc/uid/TP40008048-CH102-SW2)è¿›è¡Œäº†è§£ã€‚ç›®å‰æ²¡æœ‰getåˆ°RuntimeåŠ¨æ€æ·»åŠ æ–¹æ³•æ–¹æ³•çš„ç”¨å¤„~   ğŸ˜‚

##### ä¸ƒ.Runtime(åŠ¨æ€æ·»åŠ å±æ€§)

**å¼€å‘ä¸­ä»€ä¹ˆæ—¶å€™éœ€è¦åŠ¨æ€æ·»åŠ å±æ€§ï¼Ÿ**
 åœºæ™¯1ï¼šåœ¨åˆ†ç±»ä¸­æ·»åŠ å±æ€§ï¼Œé€šè¿‡`objc_setAssociatedObject`æ–¹æ³•æ·»åŠ å±æ€§ã€‚
 åœºæ™¯2ï¼šç»™ç³»ç»Ÿçš„ç±»æ·»åŠ å±æ€§çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨runtimeåŠ¨æ€æ·»åŠ å±æ€§æ–¹æ³•ã€‚
 å¦‚ï¼š

```
- (void)setName:(NSString *)name {
    // id  _Nonnull object ç»™é‚£ä¸ªå¯¹è±¡æ·»åŠ å±æ€§
    // const void * _Nonnull key å±æ€§åç§°
    // id  _Nullable value å±æ€§å€¼
    // objc_AssociationPolicy policy ä¿å­˜ç­–ç•¥
    objc_setAssociatedObject(self, @"name", name, OBJC_ASSOCIATION_RETAIN_NONATOMIC);
}
- (NSString *)name {
    return objc_getAssociatedObject(self, @"name");
}
```